<!doctype html>
<html lang="en">
	<head>
		<title>Ship Materials Demo</title>
		<meta charset="utf-8">
		<style>
			#controlsbox {
				padding: 10px;
				position: fixed;
				right: 0;
				background-color: #dae7e6;
			}

			select {
				display: block;
			}
		</style>
		<script src="../../js/jquery.min.js"></script>
		<script src="../../js/Three.js"></script>
		<script src="../../js/RequestAnimationFrame.js"></script>

		<script id="vertexShader" type="x-shader/x-vertex">
			uniform vec3 lightPosition;
			uniform vec3 eyePosition;

			varying vec2 texCoord;
			varying vec3 viewDirection;
			varying vec3 lightDirection;
			varying vec3 Normal;

			void main()
			{
				vec4 objectPosition = modelViewMatrix * vec4(position, 1.0);
				gl_Position         = projectionMatrix * objectPosition;

				Normal              = normalMatrix * normal;

				viewDirection       = eyePosition - objectPosition.xyz;
				lightDirection      = lightPosition - objectPosition.xyz;

				texCoord            = uv;
			}
		</script>

		<script id="fragmentShader" type="x-shader/x-fragment">
			varying vec3 viewDirection;
			varying vec3 lightDirection;
			varying vec3 Normal;
			varying vec2 texCoord;

			uniform sampler2D baseMap;
			uniform sampler2D patternMap;
			uniform sampler2D colorMap;
			uniform sampler2D specularMap;
			uniform sampler2D glowMap;

#define COLORMAP
#define SPECULARMAP
#define GLOWMAP

			void main()
			{
				vec3 fvLightDirection = normalize(lightDirection);
				vec3 fvNormal         = normalize(Normal);

				float nDotL           = dot(fvNormal, fvLightDirection);
				vec3  fvReflection    = normalize( ( ( 2.0 * fvNormal ) * nDotL ) - fvLightDirection );
				vec3  fvViewDirection = normalize( viewDirection );
				float fRDotV          = max( 0.0, dot(fvReflection, fvViewDirection) );
#ifdef COLORMAP
				vec4  pattern         = texture2D(patternMap, texCoord);
				vec4 color            = texture2D(colorMap, vec2(pattern.r, 0.0));
				vec4 fvBaseColor      = texture2D(baseMap, texCoord) * color;
#else
				vec4 fvBaseColor      = texture2D(baseMap, texCoord);
#endif

				vec4 fvAmbient = vec4(0.0);
#ifdef GLOWMAP
				vec4 glowColor        = texture2D(glowMap, texCoord);
				fvAmbient += glowColor;
#endif
				vec4  fvTotalAmbient   = fvAmbient * fvBaseColor;

				float fSpecularPower = 25.0;
				vec4 fvSpecular = vec4(1.0, 0.0, 0.0, 1.0);
#ifdef SPECULARMAP
				float specpow         = 0.8;
				vec4 specu            = specpow * texture2D(specularMap, texCoord);
				vec4  fvTotalSpecular  = specu * ( pow( fRDotV, fSpecularPower ) );
#else
				vec4 fvTotalSpecular  = fvSpecular * pow( fRDotV, fSpecularPower );
#endif
				vec4 fvTotalDiffuse = nDotL * fvBaseColor;
				fvTotalDiffuse.w = 1.0;
				gl_FragColor = ( fvTotalAmbient + fvTotalDiffuse + fvTotalSpecular );
			}
		</script>
	</head>
	<body>
		<!--<h1>Thingy</h1>-->
		<b>MOVE</b> mouse &amp; press <b>LEFT/A:</b> rotate, <b>MIDDLE/S:</b> zoom, <b>RIGHT/D:</b> pan
		<script>
			var radius = 7;
			var width = 800, height = 800,
			container, camera, controls, scene, renderer, uniforms, light1;
			var patterns;

			window.onload = function() {
				//todo - add webgl detector check
				init();
				animate();
			};

			function init() {
				container = document.createElement('div');
				document.body.appendChild(container);

				scene = new THREE.Scene();

				renderer = new THREE.WebGLRenderer( { clearAlpha: 1, clearColor: 0x000000 } );
				renderer.setSize(width, height);
				renderer.autoClear = false;

				container.appendChild(renderer.domElement);

				//camera
				camera = new THREE.PerspectiveCamera(25, width/height, 1, 1000);
				camera.position.z = radius;

				//controls
				controls = new THREE.TrackballControls( camera, renderer.domElement );

				controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.2;

				controls.noZoom = false;
				controls.noPan = false;

				controls.staticMoving = false;
				controls.dynamicDampingFactor = 0.3;

				controls.minDistance = radius * 0.5;
				controls.maxDistance = radius * 100;

				controls.keys = [ 65, 83, 68 ]; // [ rotateKey, zoomKey, panKey ]

				//lights
				//scene.add( new THREE.AmbientLight( 0xffffff ) );
				light1 = new THREE.PointLight( 0xff0040, 2, 50 );
				light1.position.y = 3;
				light1.position.z = 0;
				scene.add( light1 );
				//var sphere = new THREE.SphereGeometry( 0.5, 16, 8 );
				//var l1 = new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: 0xff0040 } ) );
				//l1.position = light1.position;
				//scene.add( l1 );

				//textures
				patterns = {
					"blank01" : THREE.ImageUtils.loadTexture("pattern_black.png"),
					"blank02" : THREE.ImageUtils.loadTexture("pattern_white.png"),
					"wild01" : THREE.ImageUtils.loadTexture("pattern_blobs.png"),
					"wild02" : THREE.ImageUtils.loadTexture("pattern_wavy.png"),
					"wild03" : THREE.ImageUtils.loadTexture("pattern_camo.png"),
					"mystery" : THREE.ImageUtils.loadTexture("decal_mushroom.png"),
				};

				speculars = {
					"none" : THREE.ImageUtils.loadTexture("pattern_white.png"),
					"flakes" : THREE.ImageUtils.loadTexture("specular_flakes.png"),
					"scratches" : THREE.ImageUtils.loadTexture("specular_scratches.png"),
				};

				//shaders
				uniforms = {
					lightPosition: { type: "v3", value: new THREE.Vector3( 0, 0, 0 ) },
					eyePosition:   { type: "v3", value: new THREE.Vector3( 0, 0, 0 ) },
					baseMap:       { type: "t", value: 0, texture: THREE.ImageUtils.loadTexture( "diffuse.png" ) },
					patternMap:    { type: "t", value: 1, texture: THREE.ImageUtils.loadTexture( "pattern02.png" ) },
					specularMap:   { type: "t", value: 2, texture: speculars["flakes"] },
					colorMap:      { type: "t", value: 3, texture: THREE.ImageUtils.loadTexture( "gradient06.png" ) },
					glowMap:       { type: "t", value: 4, texture: THREE.ImageUtils.loadTexture( "glowmap.png" ) },
				};

				materialShip = new THREE.ShaderMaterial({
					uniforms: uniforms,
					vertexShader: document.getElementById( 'vertexShader' ).textContent,
					fragmentShader: document.getElementById( 'fragmentShader' ).textContent
				});

				// objects
				var loader = new THREE.JSONLoader(true);
				document.body.appendChild( loader.statusDomElement );

				var callback = function(geometry) {
					object = new THREE.Mesh( geometry, materialShip);
					object.scale.x = object.scale.y = object.scale.z = 0.5;
					scene.add( object );
					loader.statusDomElement.style.display = "none";
				};
				loader.load( "Sillyship.js", callback );

				window.addEventListener('resize', onWindowResize, false );

				populateMenus();
			}

			function onWindowResize(event) {
				width = 800;
				height = 600;

				renderer.setSize(width, height);

				camera.aspect = width / height;
				camera.updateProjectionMatrix();

				controls.screen.width = width;
				controls.screen.height = height;

				camera.radius = (width + height) / 4;
			}

			function animate() {
				requestAnimationFrame(animate);
				render();
			}

			function render() {
				uniforms.eyePosition.value = camera.position;
				uniforms.lightPosition.value = light1.position;
				controls.update()
				renderer.clear();
				renderer.render(scene, camera);
			}

			function lightChange() {
				light1.position.y = $('#lightSwitch').prop("checked") ? -500 : 3;
			}

			function patternChange() {
				uniforms.patternMap.texture = patterns[$("#pattern").val()];
			}

			function specularChange() {
				uniforms.specularMap.texture = speculars[$("#specular").val()];
			}

			function populateMenus() {
				$.each(patterns, function(key, value) {
					console.log(key);
					$("#pattern").append(new Option(key, key));
				});
			}
		</script>
	</body>
	<br />yesyes, I left the back of the model unfinished
	<div id="controlsbox">
		<input type="checkbox" id="lightSwitch" name="lightState" onchange="lightChange();"/>Make it dark<br />
		Pattern
		<select id="pattern" onchange="patternChange();">
		</select>
		Specular map
		<select id="specular" onchange="specularChange();">
			<option value="flakes">Flakes</option>
			<option value="scratches">Scratches</option>
			<option value="none">None</option>
		</select>
	</div>
</html>
