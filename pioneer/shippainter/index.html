<!doctype html>
<html lang="en">
	<head>
		<title>Ship Materials Demo</title>
		<meta charset="utf-8">
		<style>
		</style>
		<script src="../../js/Three.js"></script>
		<script src="../../js/RequestAnimationFrame.js"></script>

		<script id="vertexShader" type="x-shader/x-vertex">
			uniform vec3 lightPosition;
			uniform vec3 eyePosition;

			varying vec2 texCoord;
			varying vec3 viewDirection;
			varying vec3 lightDirection;
			varying vec3 Normal;

			void main()
			{
				vec4 objectPosition = modelViewMatrix * vec4(position, 1.0);
				gl_Position         = projectionMatrix * objectPosition;

				Normal              = normalMatrix * normal;

				viewDirection       = eyePosition - objectPosition.xyz;
				lightDirection      = lightPosition - objectPosition.xyz;

				texCoord            = uv;
			}
		</script>

		<script id="fragmentShader" type="x-shader/x-fragment">
			varying vec3 viewDirection;
			varying vec3 lightDirection;
			varying vec3 Normal;
			varying vec2 texCoord;
			uniform sampler2D baseMap;

			void main()
			{
				vec3 fvLightDirection = normalize(lightDirection);
				vec3 fvNormal = normalize(Normal);
				vec4 fvBaseColor = texture2D(baseMap, texCoord);

				float nDotL = dot(fvNormal, fvLightDirection);

				vec4 fvTotalDiffuse = nDotL * fvBaseColor;
				gl_FragColor = fvTotalDiffuse;
			}
		</script>
	</head>
	<body>
		<h1>Thingy</h1>
		<b>MOVE</b> mouse &amp; press <b>LEFT/A:</b> rotate, <b>MIDDLE/S:</b> zoom, <b>RIGHT/D:</b> pan
		<script>
			var radius = 7;
			var width = 800, height = 800,
			container, camera, controls, scene, renderer, uniforms, light1;

			window.onload = function() {
				//todo - add webgl detector check
				init();
				animate();
			};

			function init() {
				container = document.createElement('div');
				document.body.appendChild(container);

				scene = new THREE.Scene();

				renderer = new THREE.WebGLRenderer( { clearAlpha: 1, clearColor: 0x000000 } );
				renderer.setSize(width, height);
				renderer.autoClear = false;

				container.appendChild(renderer.domElement);

				//camera
				camera = new THREE.PerspectiveCamera(25, width/height, 1, 1000);
				camera.position.z = radius;

				//controls
				controls = new THREE.TrackballControls( camera, renderer.domElement );

				controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.2;

				controls.noZoom = false;
				controls.noPan = false;

				controls.staticMoving = false;
				controls.dynamicDampingFactor = 0.3;

				controls.minDistance = radius * 0.5;
				controls.maxDistance = radius * 100;

				controls.keys = [ 65, 83, 68 ]; // [ rotateKey, zoomKey, panKey ]

				//lights
				//scene.add( new THREE.AmbientLight( 0xffffff ) );
				light1 = new THREE.PointLight( 0xff0040, 2, 50 );
				light1.position.y = 3;
				light1.position.z = 0;
				scene.add( light1 );
				var sphere = new THREE.SphereGeometry( 0.5, 16, 8 );
				var l1 = new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: 0xff0040 } ) );
				l1.position = light1.position;
				scene.add( l1 );

				//textures

				//shaders
				uniforms = {
					lightPosition: { type: "v3", value: new THREE.Vector3( 0, 0, 0 ) },
					eyePosition:   { type: "v3", value: new THREE.Vector3( 0, 0, 0 ) },
					baseMap:       { type: "t", value: 0, texture: THREE.ImageUtils.loadTexture( "uvgrid.jpg" ) },
				};

				materialShip = new THREE.ShaderMaterial({
					uniforms: uniforms,
					vertexShader: document.getElementById( 'vertexShader' ).textContent,
					fragmentShader: document.getElementById( 'fragmentShader' ).textContent
				});

				// objects
				var loader = new THREE.JSONLoader(true);
				document.body.appendChild( loader.statusDomElement );

				var callback = function(geometry) {
					object = new THREE.Mesh( geometry, materialShip);
					object.scale.x = object.scale.y = object.scale.z = 0.5;
					scene.add( object );
					loader.statusDomElement.style.display = "none";
				};
				loader.load( "Sillyship.js", callback );

				window.addEventListener('resize', onWindowResize, false );
			}

			function onWindowResize(event) {
				width = 800;
				height = 600;

				renderer.setSize(width, height);

				camera.aspect = width / height;
				camera.updateProjectionMatrix();

				controls.screen.width = width;
				controls.screen.height = height;

				camera.radius = (width + height) / 4;
			}

			function animate() {
				requestAnimationFrame(animate);
				render();
			}

			function render() {
				uniforms.viewPosition = camera.position;
				uniforms.lightPosition = light1.position;
				controls.update()
				renderer.clear();
				renderer.render(scene, camera);
			}
		</script>
	</body>
</html>
